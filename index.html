<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>dev tetris</title>
    <style>
        body {
            background-color: rgb(29, 29, 25);
        }

        #main1 {
            position: absolute;
            top: 100px;
            left: 100px;
        }

        #read1 {
            position: absolute;
            top: 100px;
            left: 300px;
            transform: scale(0.3);
        }

        #main1 div,
        #ready1 div,
        #main2 div,
        #ready2 div {
            position: absolute;
        }

        .box {
            display: none;
            width: 600px;
            height: 700px;
            line-height: 700px;
            text-align: center;
            color: azure;
            font-size: 40px;
            backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, .9);
            background: rgba(0, 0, 0, .1);
            z-index: 10;
        }
    </style>
</head>

<body>
    <!-- <script type="text/javascript" src="base.js"></script> -->
    <script type="text/javascript" src="draw.js"></script>

    <script type="module">
        // chrome --allow-file-access-from-files
        import { Background, BackgroundLog } from "./base.js";

        function step() {

            let [oldBg, newBg, exBg, status] = bg.run1Step(bgLog);

            if (status[0] == 0) {
                // console.log(`oldBg:size=${oldBg.length} ${oldBg},\nnewBg:size=${newBg.length} ${newBg},\n exBg:size=${exBg.length} ${exBg}`)
                hold1.style.display = 'none';

                for (let i = 0; i < exBg.length; i += 3) {
                    let oldDiv = document.getElementById(`${exBg[i]},${exBg[i + 1]}`);
                    oldDiv.className = exBg[i + 1] >= 0 ? `c${exBg[i + 2]}` : '';

                }

                let i = 0, diff_size = newBg.length - oldBg.length;

                for (; i < (diff_size > 0 ? oldBg.length : newBg.length); i += 3) {
                    let x = newBg[i], y = newBg[i + 1], oldDiv = document.getElementById(`${oldBg[i]},${oldBg[i + 1]}`);
                    oldDiv.style.left = `${x * 3}8px`;
                    oldDiv.style.top = `${y * 3}8px`;
                    oldDiv.className = y >= 0 ? `c${newBg[i + 2]}` : '';
                    oldDiv.id = `${x},${y}`;
                }

                if (diff_size > 0) {
                    for (; i < newBg.length; i += 3) {
                        let x = newBg[i], y = newBg[i + 1], newDiv = document.createElement("div");
                        newDiv.id = `${x},${y}`;
                        newDiv.style.left = `${x * 3}8px`;
                        newDiv.style.top = `${y * 3}8px`;
                        newDiv.className = y >= 0 ? `c${newBg[i + 2]}` : '';
                        main1.appendChild(newDiv);

                    }

                } else {
                    for (; i < oldBg.length; i += 3) {
                        let oldDiv = document.getElementById(`${oldBg[i]},${oldBg[i + 1]}`);
                        oldDiv.remove();
                    }

                }


            } else if (status[0] == 1 || status[0] == 2) {
                hold1.style.display = 'block';
                hold1.innerText =  status[0] == 1 ? 'push' : 'game over';

            } else if (status[0] == 3) {
                for (const div of Array.from(main1.getElementsByTagName(`div`))) { div.remove(); }
                bgLog.init();

            }

            setTimeout(() => { step() }, 60);

        }

        let show = true;
        const bgLog = new BackgroundLog();
        const bg = new Background(window);
        document.getElementsByTagName('head')[0].appendChild(initStyle());

        const main1 = document.getElementById('main1');
        const ready1 = document.getElementById('ready1');
        const hold1 = document.getElementById('hold1');
        step()

    </script>
    <div id="main1"></div>
    <div id="ready1"></div>
    <div id="main2"></div>
    <div id="ready2"></div>
    <div id="hold1" class="box"></div>
</body>

</html>