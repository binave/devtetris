<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>dev tetris</title>
    <style>
        body {
            background-color: rgb(29, 29, 25);
        }

        div {
            position: absolute;
            /*display: none;*/
        }
    </style>
</head>

<body>
    <!-- <script type="text/javascript" src="base.js"></script> -->
    <script type="text/javascript" src="draw.js"></script>

    <script type="module">
        // chrome --allow-file-access-from-files
        import { Background, BackgroundLog } from "./base.js";

        function step() {

            let [oldBg, newBg, exBg, status] = bg.run1Step(bgLog);

            if (status == 0) {
                // console.log(`oldBg:size=${oldBg.length} ${oldBg},\nnewBg:size=${newBg.length} ${newBg},\n exBg:size=${exBg.length} ${exBg}`)

                for (let i = 0; i < exBg.length; i += 3) {
                    let oldDiv = document.getElementById(`${exBg[i]},${exBg[i + 1]}`);
                    oldDiv.className = exBg[i + 1] >= 0 ? `c${exBg[i + 2]}` : '';

                }

                let i = 0, diff_size = newBg.length - oldBg.length;

                for (; i < (diff_size > 0 ? oldBg.length : newBg.length); i += 3) {
                    let oldDiv = document.getElementById(`${oldBg[i]},${oldBg[i + 1]}`);
                    oldDiv.style.left = `${newBg[i] * 3}8px`;
                    oldDiv.style.top = `${newBg[i + 1] * 3}8px`;
                    oldDiv.className = newBg[i + 1] >= 0 ? `c${newBg[i + 2]}` : '';
                    oldDiv.id = `${newBg[i]},${newBg[i + 1]}`;
                }


                if (diff_size > 0) {
                    for (; i < newBg.length; i += 3) {
                        let newDiv = document.createElement("div");
                        newDiv.id = `${newBg[i]},${newBg[i + 1]}`;
                        newDiv.style.left = `${newBg[i] * 3}8px`;
                        newDiv.style.top = `${newBg[i + 1] * 3}8px`;
                        newDiv.className = newBg[i + 1] >= 0 ? `c${newBg[i + 2]}` : '';
                        body.appendChild(newDiv);

                    }

                } else {
                    for (; i < oldBg.length; i += 3) {
                        let oldDiv = document.getElementById(`${oldBg[i]},${oldBg[i + 1]}`);
                        oldDiv.remove();
                    }

                }

            }

            setTimeout(() => { step() }, 60);

        }

        const bgLog = new BackgroundLog();
        const bg = new Background(window);

        document.getElementsByTagName('head')[0].appendChild(initStyle());

        const body = document.getElementsByTagName('body')[0];

        step()

    </script>

</body>

</html>